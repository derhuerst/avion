!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.linkup=e()}}(function(){return function e(t,n,o){function i(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(r)return r(s,!0);throw new Error("Cannot find module '"+s+"'")}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return i(n?n:e)},l,l.exports,e,t,n,o)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<o.length;s++)i(o[s]);return i}({1:[function(e,t){var n;n=function(){function e(){this._events={}}return e.prototype._events=null,e.prototype.emit=function(e,t){var n,o,i,r;if(this._events[e])for(r=this._events[e],o=0,i=r.length;i>o;o++)n=r[o],n.call(this,t);return this},e.prototype.on=function(e,t){var n;return null==(n=this._events)[e]&&(n[e]=[]),this._events[e].push(t)},e.prototype.once=function(e,t){var n;return n=function(o){return this.removeListener(e,n),t(o)},this.on(e,n)},e}(),t.exports=n},{}],2:[function(e,t){var n,o,i,r={}.hasOwnProperty,s=function(e,t){function n(){this.constructor=e}for(var o in t)r.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};i=e("./uid.coffee"),n=e("./EventEmitter.coffee"),o=function(e){function t(e){t.__super__.constructor.apply(this,arguments),this.id=e.id||i(9),e instanceof window.File?(this.file=e,this.mode="send"):e.file instanceof window.File?(this.file=e.file,this.mode="send"):this.mode="receive",this.name=e.name||this.file.name,this.size=e.size||this.file.size,this.type=e.type||this.file.type,this.on("init",function(e){return function(){return e.status="init"}}(this)),this.on("wait",function(e){return function(){return e.status="wait"}}(this)),this.on("transfer",function(e){return function(){return e.status="transfer"}}(this)),this.on("complete",function(e){return function(){return e.status="complete"}}(this)),this.on("error",function(e){return function(){return e.status="error"}}(this)),this.emit("init")}return s(t,e),t.prototype.id=null,t.prototype.mode=null,t.prototype.status=null,t.prototype.file=null,t.prototype.name=null,t.prototype.size=null,t.prototype.type=null,t.prototype.readAsBuffer=function(e){var t;return t=new FileReader,t.onload=function(){return e(t.result)},t.readAsArrayBuffer(this.file)},t.prototype.saveFromBuffer=function(e){var t;return t=new Blob([e],{type:this.type}),saveAs(t,this.name)},t}(n),t.exports=o},{"./EventEmitter.coffee":1,"./uid.coffee":5}],3:[function(e,t){var n,o,i,r,s=function(e,t){return function(){return e.apply(t,arguments)}},a={}.hasOwnProperty,u=function(e,t){function n(){this.constructor=e}for(var o in t)a.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};r=e("./uid.coffee"),n=e("./EventEmitter.coffee"),o=e("./File.coffee"),i=function(e){function t(){this._onData=s(this._onData,this),this._onCommand=s(this._onCommand,this),t.__super__.constructor.apply(this,arguments),this.id=r(6),this.on("open",function(){return this.isOpen=!0,this.isIdle=!1}),this.on("close",function(){return this.isOpen=!1,this.isIdle=!1}),this.on("error",function(){return this.isOpen=!1,this.isIdle=!1}),this.on("complete",function(){return this.isIdle=!0}),this.on("transfer",function(){return this.isIdle=!1}),this._peerjs=new window.Peer(this.id,{key:"2c5evmxvq0i442t9"}),this._peerjs.on("close",function(e){return function(){return e._log("underlying PeerJS peer closed"),e.emit("close")}}(this)),this._peerjs.on("error",function(e){return function(t){return e._log("underlying PeerJS peer throw an error: "+t,"error"),e.emit("error",t)}}(this)),this.files=[],this.on("open",this._onOpen),this.on("open",function(){return this._log("connection open")}),this.on("close",this._onClose),this.on("close",function(){return this._log("connection closed")}),this.on("error",this._onClose),this.on("error",function(){return this._log("connection closed due to an error")}),this.on("add",function(e){return this._log("file added: "+e.name)}),this.on("add",this._checkSendCommand),this.on("progress",this._checkSendCommand),this.on("open",this._checkSendCommand),this.emit("close")}return u(t,e),t.prototype.id=null,t.prototype.peer=null,t.prototype._peerjs=null,t.prototype._commandConnection=null,t.prototype._dataConnection=null,t.prototype.isController=null,t.prototype.isOpen=null,t.prototype.isIdle=null,t.prototype.files=null,t.prototype.currentFile=null,t.prototype.connect=function(e){var t;return this._log("connecting to peer "+e),this.isController=!1,t=function(e){return function(){return e._commandConnection=e._peerjs.connect(e.peer,{label:"messages",serialization:"none",reliable:!0}),e._onConnection(e._commandConnection),e._dataConnection=e._peerjs.connect(e.peer,{label:"data",serialization:"binary",reliable:!0}),e._onConnection(e._dataConnection)}}(this),this.peer=e,this._peerjs.open?t():this._peerjs.on("open",t)},t.prototype.listen=function(){var e;return this._log("listening for connections"),this.isController=!0,e=function(e){return function(t){var n,o;return n={messages:"_commandConnection",data:"_dataConnection"},o=!t,l.call(n,o)>=0?e._log("request with invalid label `"+t.label+"`","warn"):e[n[t.label]]&&e[n[t.label]].open?(t.close(),e._log(""+t.label+" connection already established","warn")):(e.peer=t.peer,e[n[t.label]]=t,e._onConnection(t))}}(this),this._peerjs.on("connection",e)},t.prototype._onConnection=function(e){var t,n;return n=function(e){return function(){return e._commandConnection&&e._commandConnection.open&&e._dataConnection&&e._dataConnection.open?(e._commandConnection.on("data",e._onCommand),e._dataConnection.on("data",e._onData),e.emit("open")):void 0}}(this),t=function(e){return function(){return e.emit("close")}}(this),e.open&&n(),e.on("open",n),e.on("close",t),e.on("error",t)},t.prototype.add=function(e){return l.call(this.files,e)>=0?void 0:(this.files.push(e),this.files[e.id]=e,"send"===e.mode&&this.isOpen&&this._sendCommand("metadata",e,{name:e.name,size:e.size,type:e.type}),e.emit("wait"),this.emit("add",e))},t.prototype.send=function(e){return e=new linkup.File(e),this.add(e),e},t.prototype.remove=function(e){return this.currentFile===e&&this._log(""+e.name+": currently being transferred; cannot remove","error"),delete this.files[e.id],this.files.splice(this.files.indexOf(e),1),e.emit("init"),this.emit("remove",e)},t.prototype.status=function(){var e,t,n,o,i;for(e={init:0,wait:0,transfer:0,complete:0,error:0,all:0,send:{init:0,wait:0,transfer:0,complete:0,error:0,all:0},receive:{init:0,wait:0,transfer:0,complete:0,error:0,all:0}},i=this.files,n=0,o=i.length;o>n;n++)t=i[n],e[t.status]++,e.all++,e[t.mode][t.status]++,e[t.mode].all++;return e},t.prototype._onOpen=function(){var e,t,n,o,i;for(o=this.files,i=[],t=0,n=o.length;n>t;t++)e=o[t],i.push("init"===e.status?this._sendCommand("metadata",e,{name:e.name,size:e.size,type:e.type}):void 0);return i},t.prototype._onClose=function(){var e,t,n,o;for(o=this.files,t=0,n=o.length;n>t;t++)e=o[t],"complete"!==e.status&&e.emit("error");return this._messages&&this._messages.open&&this._messages.close(),this._messages=null,this._data&&this._data.open&&this._data.close(),this._data=null},t.prototype._sendCommand=function(e,t,n){return null==n&&(n={}),n.id=t.id,n.command=e,console.log(n),this._commandConnection.send(JSON.stringify(n)),this._log(""+t.name+": `"+e+"` command sent")},t.prototype._onCommand=function(e){var t;switch(e=JSON.parse(e),t=this.files[e.id]||null,this._log(e),this._log(this.files),this._log(""+(t?t.name:e.name)+": `"+e.command+"` command received"),e.command){case"metadata":return t=new o({id:e.id,mode:"receive",name:e.name,size:e.size,type:e.type}),this.add(t);case"receive":return this.currentFile=t,t.emit("transfer");case"send":return this.currentFile=t,t.emit("transfer"),this._sendData(t);case"ack":return t.emit("complete"),this.currentFile=null,this.emit("progress",t);default:return this._log("invalid command: "+e.command,"error")}},t.prototype._sendData=function(e){return e.readAsBuffer(function(e){return function(t){return e._dataConnection.send(t)}}(this)),this._log(""+e.name+": sending data")},t.prototype._onData=function(e){var t;return t=this.currentFile,this._log(""+t.name+": data received"),this._sendCommand("ack",t),this.currentFile=null,t.saveFromBuffer(e),t.emit("complete"),this.emit("progress",t)},t.prototype._checkSendCommand=function(e){var t,n,o;if(this._log("_checkSendCommand"),this.isOpen&&!this.currentFile){if(this.isController)for(o=this.files,t=0,n=o.length;n>t;t++)if(e=o[t],"wait"===e.status)return this.idle&&(this.idle=!1,this.emit("transfer")),this.currentFile=e,"send"===e.mode?(this._sendCommand("metadata",e,{name:e.name,size:e.size,type:e.type}),setTimeout(function(t){return function(){return t._sendCommand("receive",e),t._sendData(e)}}(this),100)):this._sendCommand("send",e),void e.emit("transfer");return this.idle?void 0:(this.idle=!0,this.emit("complete"))}},t.prototype._log=function(e,t){return null==t&&(t="info"),console[t]("[linkup."+this.constructor.name+" #"+this.id+"] ",e)},t}(n),t.exports=i},{"./EventEmitter.coffee":1,"./File.coffee":2,"./uid.coffee":5}],4:[function(e,t){t.exports={File:e("./File.coffee"),Peer:e("./Peer.coffee")}},{"./File.coffee":2,"./Peer.coffee":3}],5:[function(e,t){var n;n=function(e,t){for(t=(26*Math.random()+10|0).toString(36);--e;)t+=(36*Math.random()|0).toString(36);return t},t.exports=n},{}]},{},[4])(4)});